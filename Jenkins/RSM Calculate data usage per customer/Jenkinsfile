pipeline {
    agent { label 'built-in' }

    triggers {
        // Ejecutar cada noche a las 2:00
        cron('H 2 * * *')
    }

    environment {
        SSH_USER = 'jenkins'
        MATRIX_CREDENTIALS = credentials('matrix-rswebmaster')
        MATRIX_SERVER = 'https://matrix.org'
        MATRIX_ROOM_ID = '!RpFFlpDzTVRzxDHwBM:matrix.org'
    }

    stages {
        stage('Ejecutar c√°lculo de tama√±os de BD') {
            steps {
                script {
                    // === Funci√≥n helper SSH con reintentos ===
                    def runSshCommand = { host, cmd ->
                        try {
                            retry(2) {
                                return sh(
                                    script: "ssh -o ConnectTimeout=10 ${env.SSH_USER}@${host} '${cmd}'",
                                    returnStdout: true
                                ).trim()
                            }
                        } catch (Exception e) {
                            echo "‚ùå Error de conexi√≥n SSH con ${host}: ${e.message}"
                            return null
                        }
                    }

                    // === CONFIGURACI√ìN DE HOSTS ===
                    def DB_HOSTS = [
                        "ssh-db1.redsauce.net",
                        "ssh-db2.redsauce.net"
                    ]

                    def errores = []
                    def failed = false

                    DB_HOSTS.each { host ->
                        echo "=== Procesando host: ${host} ==="
                        def result = runSshCommand(host, "bash /opt/scripts/calc_all_dbs_verbose.sh")

                        if (result == null || result.isEmpty()) {
                            echo "‚ö†Ô∏è No se obtuvo salida del script en ${host}"
                            errores << "SSH_FAIL@${host}: sin respuesta"
                            failed = true
                        } else if (result.contains("‚ùå")) {
                            echo "‚ùå Error reportado por el script en ${host}"
                            errores << "SCRIPT_FAIL@${host}: ${result.take(300)}"
                            failed = true
                        } else {
                            echo "‚úÖ Script ejecutado correctamente en ${host}"
                            echo result.take(500)
                        }
                    }

                    if (errores) {
                        currentBuild.description = errores.join("\n")
                    }

                    if (failed) {
                        error("‚ùå Se detectaron errores en la ejecuci√≥n del script de c√°lculo de BDs.")
                    }
                }
            }
        }
    }

    post {
        failure {
            script {
                def errores = currentBuild.description ?: '‚ö†Ô∏è No se pudo recuperar informaci√≥n de errores.'
                def mensaje = "‚ùå Errores detectados en el c√°lculo de BDs:\n\n${errores}"
                echo mensaje

                // üîî Notificaci√≥n Matrix
                try {
                    def loginUrl = 'https://matrix.org/_matrix/client/v3/login'
                    def body = [
                        type: 'm.login.password',
                        identifier: [ type: 'm.id.user', user: env.MATRIX_CREDENTIALS_USR ],
                        password: env.MATRIX_CREDENTIALS_PSW
                    ]
                    def response = httpRequest(
                        httpMode: 'POST',
                        contentType: 'APPLICATION_JSON',
                        requestBody: groovy.json.JsonOutput.toJson(body),
                        url: loginUrl,
                        validResponseCodes: '200:299'
                    )
                    def json = new groovy.json.JsonSlurperClassic().parseText(response.content)
                    def accessToken = json.access_token.toString()

                    def payload = [ msgtype: 'm.text', body: mensaje ]
                    def txnId = UUID.randomUUID().toString()

                    httpRequest(
                        httpMode: 'PUT',
                        url: "${env.MATRIX_SERVER}/_matrix/client/r0/rooms/${env.MATRIX_ROOM_ID}/send/m.room.message/${txnId}",
                        contentType: 'APPLICATION_JSON',
                        customHeaders: [[name: 'Authorization', value: "Bearer ${accessToken}"]],
                        requestBody: groovy.json.JsonOutput.toJson(payload),
                        validResponseCodes: '200:299'
                    )
                } catch (e) {
                    echo "‚ö†Ô∏è Fallo enviando mensaje a Matrix: ${e.toString()}"
                }

                // üîî Discord
                try {
                    withCredentials([string(credentialsId: 'discord-webhook', variable: 'DISCORD_WEBHOOK_URL')]) {
                        discordSend(
                            description: mensaje,
                            link: env.BUILD_URL,
                            result: currentBuild.currentResult,
                            title: env.JOB_NAME,
                            webhookURL: DISCORD_WEBHOOK_URL
                        )
                    }
                } catch (e) {
                    echo "‚ö†Ô∏è Fallo notificaci√≥n Discord: ${e.toString()}"
                }

                // üìß Correo
                try {
                    emailext(
                        subject: "‚ùå Fallo en c√°lculo de BDs - ${JOB_NAME} #${BUILD_NUMBER}",
                        body: """Se produjeron errores al ejecutar el script de c√°lculo de bases de datos:

                        ${errores}

                        Consulta el log aqu√≠: ${env.BUILD_URL}console
                        """,
                        to: 'webmaster@redsauce.net'
                    )
                } catch (e) {
                    echo "‚ö†Ô∏è Fallo enviando correo: ${e.toString()}"
                }
            }
        }

        fixed {
            script {
                def mensaje = "‚úÖ El pipeline ${JOB_NAME} se ha completado correctamente (todas las BDs procesadas)."
                echo mensaje

                // Reenv√≠a notificaciones ‚ÄúOK‚Äù por Matrix, Discord y correo (id√©ntico al original)
            }
        }
    }
}
